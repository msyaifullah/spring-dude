#!/bin/sh
# Pre-commit hook to format code using Spotless
# This hook runs before each commit to ensure code is properly formatted

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the project root directory using Git
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# Change to project root
cd "$PROJECT_ROOT" || exit 1

echo -e "${BLUE}[PRE-COMMIT]${NC} Running code formatting check..."

# Check if Maven is available
if ! command -v mvn > /dev/null 2>&1; then
    echo -e "${YELLOW}[WARN]${NC} Maven not found. Skipping code formatting."
    exit 0
fi

# Check if Spotless plugin is configured
if ! mvn help:evaluate -Dexpression=spotless-maven-plugin.version -q -DforceStdout > /dev/null 2>&1; then
    echo -e "${YELLOW}[WARN]${NC} Spotless plugin not configured. Skipping code formatting."
    exit 0
fi

# Get list of staged Java files
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.java$' || true)

# If no Java files are staged, skip formatting
if [ -z "$STAGED_JAVA_FILES" ]; then
    echo -e "${GREEN}[PRE-COMMIT]${NC} No Java files staged. Skipping formatting."
    exit 0
fi

echo -e "${BLUE}[PRE-COMMIT]${NC} Formatting staged Java files..."

# Run Spotless to format code
mvn spotless:apply -q

# Check if formatting changed any files
FORMATTED_FILES=$(git diff --name-only)

if [ -n "$FORMATTED_FILES" ]; then
    echo -e "${YELLOW}[PRE-COMMIT]${NC} Code was automatically formatted. Staging formatted files..."
    
    # Add formatted files back to staging area
    echo "$FORMATTED_FILES" | while read -r file; do
        if [ -n "$file" ]; then
            git add "$file"
            echo -e "  ${GREEN}+${NC} $file"
        fi
    done
    
    echo -e "${GREEN}[PRE-COMMIT]${NC} Formatted files have been staged. You can now commit."
fi

# Verify formatting is correct
echo -e "${BLUE}[PRE-COMMIT]${NC} Verifying code formatting..."
if ! mvn spotless:check -q; then
    echo -e "${RED}[PRE-COMMIT]${NC} Code formatting check failed!"
    echo -e "${YELLOW}[PRE-COMMIT]${NC} Please run 'mvn spotless:apply' or 'make format' to fix formatting issues."
    exit 1
fi

echo -e "${GREEN}[PRE-COMMIT]${NC} Code formatting check passed!"
exit 0

